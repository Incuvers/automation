#!/bin/bash

build(){
  cd "$BUILD" || exit
  tar -xvf "$NAME".xz
  cd - || exit
}

build_usbboot(){
  git submodule update --init --recursive
  echo "Syncing with upstream usbboot"
  git submodule update --remote
  cd usbboot
  make
}

printf "%b" "${OKB}Installing homebrew dependancies ...${}"
xargs brew install < dependencies.txt
printf "%b" "${OKG} ✓ ${NC} complete\n"

printf "${OKB}Preparing usbboot submodule ...${NC}"
build_usbboot && printf "%b" "${OKG} ✓ ${NC} complete\n" ||
  printf "%b" "${FAIL} ✗ ${NC} usbboot build failed.\n" && exit 1;

echo "Preparing build ..."
mkdir build
build_path="$(cd build || exit 1; pwd -P)"
export BUILD="$build_path"
printf "${OKG} ✓ ${NC} complete"

printf "%b" "${OKB}Fetching latest Ubuntu 20.04 release for CM3+${NC}\n"
curl -L  "${IMG}" --output build/"$NAME".xz
printf "%b" "${OKG} ✓ ${NC} complete\n"

echo "Extracting Ubuntu img ..."
build
printf "%b" "${OKG} ✓ ${NC} complete\n"